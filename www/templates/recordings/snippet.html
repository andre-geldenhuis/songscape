{% extends 'base.html' %}
{% load staticfiles %}
{% load recording_filters %}

{% block content %}

{% block toprow %}
<ul class="pager">
{% if previous_index and not analysis %}
  <li class="previous">
    <a href="{% url 'snippet_list' previous_index %}">&larr; Previous</a>
  </li>
{% endif %}
  <li>
    <span>{{ snippet.recording.deployment.site }}, {{ snippet.datetime }}</span>
  </li>
{% if index %}
  <li>
    <span>{{ index }} of {{ count }}</span>
  </li>
{% endif %}
{% if next_index and not analysis %}
  <li class="next">
    <a href="{% url 'snippet_list' next_index %}">Next &rarr;</a>
  </li>
{% endif %}
</ul>
{% endblock toprow %}
{% block secondrow %}
{% endblock secondrow %}
{% if not analysis %}
<div class="row">
  <div>
    <ul class="inline">
        {% for tag, c in tags.items %}
        <li class="outlined">{{ tag }} <span class="badge">{{ c }}</span></li>
        {% endfor %}
    </ul>
  </div>
</div>
{% endif %}
  <div>
    <audio id="snippet" preload="none">
     <source src="{{ snippet|wav_url }}" type="audio/wav">
     "Hmm can't play the sound"
    </audio>
  </div>
<canvas id="canvas" width="1000" height="360"></canvas>
<a href="{{ snippet|wav_url }}" role="button" class="btn btn-default btn-sm"><span class="glyphicon glyphicon-volume-up"></span> Download sound file</a>

<button class="btn btn-default btn-sm {% if favourite %}liked{% else %}notliked{% endif %}"  id="favourite"><span class="glyphicon glyphicon-heart"></span></button>

<!-- TODO: just draw the image and pop up controls if no canvas
img id="sonogram" src="{{ snippet|sonogram_url }}" -->

{% endblock content %}

{% block script %}
<script type="text/javascript">
{% block extrascript %}
{% endblock extrascript %}
$(document).ready(function() {
  var canvas = document.getElementById("canvas");
  var context = document.getElementById('canvas').getContext('2d');
  var snippet = document.getElementById('snippet');

  var sonogram = new Image();
  sonogram.onload = function() {
    context.drawImage(this, 0, 0);
  }
  sonogram.src = '{{ snippet|sonogram_url }}';

  function draw_playback(canvas_offset) {
    // SVG might be more efficient oh well.
    // And it could be animated cleanly - oh well you have to start somewhere
    context.clearRect(0, 0, canvas.width, canvas.height);
    context.drawImage(sonogram, 0, 0);
    context.beginPath();
    context.moveTo(canvas_offset, 0);
    context.lineTo(canvas_offset, canvas.height);
    context.stroke();
    context.closePath();
  }

  /*snippet.addEventListener('canplaythrough', function(){
    console.log('Can play through');
    console.log(snippet.src);
    console.log(snippet.networkState);
    if (snippet.seekable.length === 0) {
      console.log('Reload');
      snippet.load();
    }; 
  }, false);;*/

  snippet.preload = "auto";
  $('#canvas').bind('click', function(d) {
    // hack hack - for some reason the first time a page is loaded the
    // media is not seekable - something to do with the redirect
    // Do we want to be able to pause it? Or do we just click
    // on what we want and then when done move to the next one?
    // offset = 0.13 is basically the start the sonogram and 0.9 the end.
    var sonogram_start = 0.1266;
    var sonogram_end = 0.905;
    var sonogram_range = sonogram_end - sonogram_start;
    var offset = d.offsetX / $(this).width();
    // scale accordingly
    offset -= sonogram_start;
    offset /= sonogram_range;
    if (offset > 1.0){
        snippet.currentTime = snippet.duration;
        draw_playback(canvas.width*sonogram_end);
    } 
    else if (offset < 0){
        snippet.currentTime = 0.0;
        snippet.play();
    }
    else {
        snippet.currentTime = offset * snippet.duration
        draw_playback(d.offsetX);
        snippet.play();
    };

    $('#snippet').bind('timeupdate', function(e) {
        var offset = snippet.currentTime / snippet.duration;
        offset *= sonogram_range;
        offset += sonogram_start;
        offset *= canvas.width
        draw_playback(offset);
    });

  });

});

$(document).ready(function() {
    $('#favourite').bind('click', function() {
        var $this = $(this);
        var post_id = this.id;
        if ($this.hasClass('liked')){
            var favourite_url = "{% url 'api' snippet.id 'unfavourite' %}";
        } 
        else {
            var favourite_url = "{% url 'api' snippet.id 'favourite' %}";
        };
        $.getJSON(favourite_url, function(data) {
            var newClass = (data["favourite"] == 1) ? 'liked' : 'notliked'
            $this.removeClass("liked notliked");
            $this.addClass(newClass);
        });
    });
});

{% block preload %}
{% if next_snippet %}
$(window).load(function() {
  var next_image = new Image();
  next_image.src = "{% url 'sonogram_id' id=next_snippet %}"
});
{% endif %}
{% endblock preload %}
</script>

{% endblock %}


